// ============================================================================
// SakuraEDL - SPRD Exploit Database | 展讯漏洞数据库
// ============================================================================
// [ZH] 漏洞数据库 - 存储展讯芯片漏洞信息和利用参数
// [EN] Exploit Database - Store Spreadtrum chip exploit info and parameters
// [JA] エクスプロイトDB - Spreadtrumチップの脆弱性情報とパラメータを保存
// [KO] 익스플로잇 DB - Spreadtrum 칩 취약점 정보 및 매개변수 저장
// [RU] База эксплойтов - Хранение информации об уязвимостях Spreadtrum
// [ES] Base de datos exploit - Almacenar info de vulnerabilidades Spreadtrum
// ============================================================================
// Copyright (c) 2025-2026 SakuraEDL | MIT License
// ============================================================================

using System;
using System.Collections.Generic;
using System.Linq;
using SakuraEDL.Spreadtrum.Protocol;

namespace SakuraEDL.Spreadtrum.Exploit
{
    /// <summary>
    /// 展讯漏洞数据库
    /// </summary>
    public static class SprdExploitDatabase
    {
        // 已知有漏洞的芯片
        private static readonly Dictionary<uint, List<SprdVulnerabilityInfo>> VulnerableChips = 
            new Dictionary<uint, List<SprdVulnerabilityInfo>>
        {
            // SC7731 系列 - 较早期芯片，多数有漏洞
            { 0x7731, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.FdlSignatureBypass,
                        Name = "SC7731 签名绕过",
                        Description = "SC7731 早期版本未正确验证 FDL 签名",
                        SuccessRate = 4,
                        AffectedChips = new[] { "SC7731", "SC7731C", "SC7731E" }
                    },
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.MemoryRead,
                        Name = "SC7731 内存读取",
                        Description = "可通过 BSL 命令读取敏感内存区域",
                        SuccessRate = 3,
                        AffectedChips = new[] { "SC7731" }
                    }
                }
            },

            // SC9820 系列
            { 0x9820, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.BslOverflow,
                        Name = "SC9820 BSL 溢出",
                        Description = "BSL 握手阶段存在缓冲区溢出漏洞",
                        SuccessRate = 3,
                        AffectedChips = new[] { "SC9820", "SC9820E" }
                    }
                }
            },

            // SC9830 系列
            { 0x9830, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.Downgrade,
                        Name = "SC9830 降级攻击",
                        Description = "可使用旧版 FDL 绕过安全检查",
                        SuccessRate = 3,
                        AffectedChips = new[] { "SC9830", "SC9830A" }
                    }
                }
            },

            // SC9832 系列
            { 0x9832, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.HdlcOverflow,
                        Name = "SC9832 HDLC 溢出",
                        Description = "HDLC 帧解析存在整数溢出",
                        SuccessRate = 2,
                        AffectedChips = new[] { "SC9832", "SC9832E" }
                    }
                }
            },

            // SC9850 系列
            { 0x9850, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.DebugMode,
                        Name = "SC9850 调试模式",
                        Description = "某些固件版本可激活调试模式",
                        SuccessRate = 2,
                        AffectedChips = new[] { "SC9850KA" }
                    }
                }
            },

            // SC9863 系列
            { 0x9863, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.NvBypass,
                        Name = "SC9863 NV 绕过",
                        Description = "NV 校验可被绕过",
                        SuccessRate = 2,
                        AffectedChips = new[] { "SC9863A" }
                    }
                }
            },

            // T310 系列
            { 0x0310, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.Downgrade,
                        Name = "T310 降级攻击",
                        Description = "早期 Boot ROM 版本可降级",
                        SuccessRate = 2,
                        AffectedChips = new[] { "T310" }
                    }
                }
            },

            // T606/T612/T616 系列
            { 0x0606, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.MemoryRead,
                        Name = "T606 内存读取",
                        Description = "特定条件下可读取受保护内存",
                        SuccessRate = 2,
                        AffectedChips = new[] { "T606", "T612", "T616" }
                    }
                }
            },

            // T618/T700 系列 - 较新芯片，漏洞较少
            { 0x0618, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.DebugMode,
                        Name = "T618 调试探测",
                        Description = "可尝试激活工程模式",
                        SuccessRate = 1,
                        AffectedChips = new[] { "T618" }
                    }
                }
            },

            // T610/T612/T616 系列 - 中端芯片
            { 0x0610, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.FdlSignatureBypass,
                        Name = "T610 签名验证绕过",
                        Description = "某些固件版本存在签名验证漏洞",
                        SuccessRate = 2,
                        AffectedChips = new[] { "T610", "T612", "T616" }
                    },
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.MemoryRead,
                        Name = "T610 内存读取",
                        Description = "BROM 模式下可读取受保护内存",
                        SuccessRate = 2,
                        AffectedChips = new[] { "T610" }
                    }
                }
            },

            // UMS512 系列
            { 0x0512, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.FdlSignatureBypass,
                        Name = "UMS512 签名绕过",
                        Description = "UMS512 早期版本签名验证可绕过",
                        SuccessRate = 2,
                        AffectedChips = new[] { "UMS512" }
                    }
                }
            },

            // T700/T760/T770 系列 - 高端芯片，安全性较高
            { 0x0700, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.Downgrade,
                        Name = "T700 降级探测",
                        Description = "检查是否支持旧版 FDL 降级",
                        SuccessRate = 1,
                        AffectedChips = new[] { "T700", "T760", "T770" }
                    }
                }
            },

            // SC8541E 系列 - 入门级 4G
            { 0x8541, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.NvBypass,
                        Name = "SC8541E NV 绕过",
                        Description = "NV 校验逻辑可能被绕过",
                        SuccessRate = 2,
                        AffectedChips = new[] { "SC8541E" }
                    }
                }
            }
        };

        // 已知的 Unfused PK Hash (测试/开发设备)
        private static readonly HashSet<string> UnfusedPkHashes = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
        {
            "0000000000000000000000000000000000000000000000000000000000000000",
            "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF",
            "00000000000000000000000000000000",
            "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"
        };

        /// <summary>
        /// 检查设备漏洞
        /// </summary>
        public static SprdVulnerabilityCheckResult CheckVulnerabilities(uint chipId, string pkHash = null)
        {
            var result = new SprdVulnerabilityCheckResult
            {
                ChipId = chipId,
                PkHash = pkHash
            };

            // 1. 检查是否为 Unfused 设备
            if (!string.IsNullOrEmpty(pkHash) && IsUnfusedDevice(pkHash))
            {
                result.HasVulnerability = true;
                result.IsUnfused = true;
                result.Reason = "Unfused 设备，可加载任意 FDL";
                result.RecommendedExploit = SprdExploitType.FdlSignatureBypass;
                result.AvailableExploits.Add(new SprdVulnerabilityInfo
                {
                    Type = SprdExploitType.FdlSignatureBypass,
                    Name = "Unfused 设备",
                    Description = "设备未烧录安全密钥，可直接加载未签名固件",
                    SuccessRate = 5
                });
                return result;
            }

            // 2. 检查芯片特定漏洞
            // 尝试精确匹配
            if (VulnerableChips.TryGetValue(chipId, out var vulns))
            {
                result.HasVulnerability = true;
                result.Reason = string.Format("芯片 0x{0:X} 存在已知漏洞", chipId);
                result.AvailableExploits.AddRange(vulns);
                result.RecommendedExploit = vulns.OrderByDescending(v => v.SuccessRate).First().Type;
                return result;
            }

            // 尝试匹配系列
            uint chipSeries = GetChipSeries(chipId);
            if (VulnerableChips.TryGetValue(chipSeries, out vulns))
            {
                result.HasVulnerability = true;
                result.Reason = string.Format("芯片系列 0x{0:X} 存在已知漏洞", chipSeries);
                result.AvailableExploits.AddRange(vulns);
                result.RecommendedExploit = vulns.OrderByDescending(v => v.SuccessRate).First().Type;
                return result;
            }

            // 3. 未找到漏洞
            result.HasVulnerability = false;
            result.Reason = "未检测到已知漏洞";
            return result;
        }

        /// <summary>
        /// 检查是否为 Unfused 设备
        /// </summary>
        public static bool IsUnfusedDevice(string pkHash)
        {
            if (string.IsNullOrEmpty(pkHash))
                return false;

            // 检查已知的 Unfused Hash
            if (UnfusedPkHashes.Contains(pkHash))
                return true;

            // 检查全零或全 F
            if (pkHash.All(c => c == '0') || pkHash.All(c => c == 'F' || c == 'f'))
                return true;

            return false;
        }

        /// <summary>
        /// 获取芯片系列
        /// </summary>
        private static uint GetChipSeries(uint chipId)
        {
            // SC77xx 系列
            if (chipId >= 0x7700 && chipId < 0x7800)
                return 0x7731;

            // SC98xx 系列
            if (chipId >= 0x9800 && chipId < 0x9900)
            {
                if (chipId >= 0x9860)
                    return 0x9863;
                if (chipId >= 0x9850)
                    return 0x9850;
                if (chipId >= 0x9830)
                    return 0x9832;
                return 0x9820;
            }

            // T3xx 系列
            if (chipId >= 0x0300 && chipId < 0x0400)
                return 0x0310;

            // T6xx 系列
            if (chipId >= 0x0600 && chipId < 0x0700)
            {
                if (chipId >= 0x0618)
                    return 0x0618;
                return 0x0606;
            }

            return chipId;
        }

        /// <summary>
        /// 获取芯片名称
        /// </summary>
        public static string GetChipName(uint chipId)
        {
            return SprdPlatform.GetPlatformName(chipId);
        }

        /// <summary>
        /// 获取所有已知漏洞
        /// </summary>
        public static List<SprdVulnerabilityInfo> GetAllKnownVulnerabilities()
        {
            var all = new List<SprdVulnerabilityInfo>();
            foreach (var kvp in VulnerableChips)
            {
                all.AddRange(kvp.Value);
            }
            return all.Distinct().ToList();
        }

        /// <summary>
        /// 按漏洞类型获取受影响芯片
        /// </summary>
        public static List<uint> GetAffectedChips(SprdExploitType exploitType)
        {
            var chips = new List<uint>();
            foreach (var kvp in VulnerableChips)
            {
                if (kvp.Value.Any(v => v.Type == exploitType))
                {
                    chips.Add(kvp.Key);
                }
            }
            return chips;
        }
    }
}
